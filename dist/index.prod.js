"use strict";function _slicedToArray(o,e){return _arrayWithHoles(o)||_iterableToArrayLimit(o,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(o,e){if(Symbol.iterator in Object(o)||"[object Arguments]"===Object.prototype.toString.call(o)){var r=[],s=!0,t=!1,u=void 0;try{for(var n,i=o[Symbol.iterator]();!(s=(n=i.next()).done)&&(r.push(n.value),!e||r.length!==e);s=!0);}catch(o){t=!0,u=o}finally{try{s||null==i.return||i.return()}finally{if(t)throw u}}return r}}function _arrayWithHoles(o){if(Array.isArray(o))return o}var fs=require("fs"),https=require("https"),mysql=require("mysql"),DatabasePool=require("./db"),db=new DatabasePool,banned_words=db.getBannedWords(),server=https.createServer({key:fs.readFileSync("/home/azureuser/private.key"),cert:fs.readFileSync("/home/azureuser/certificate.crt")}),io=require("socket.io")(server,{cors:{origin:"https://morahman.me",methods:["GET","POST"]}});server.listen(3e3);var groups={};io.on("connection",function(t){console.log("New connection."),t.on("refreshBannedWords",function(){banned_words=db.getBannedWords(),console.log("Refreshing banned words...")}),t.on("joinedGroup",function(o){t.spotifyId=o.id,t.group=o.group,t.join(o.group),groups.hasOwnProperty(t.group)||(groups[t.group]={users:{},likes:{},queue:[],host:t.spotifyId,hostSocket:t.id}),groups[t.group].users[t.spotifyId]={prof_pic:o.prof_pic,name:o.name,socket:t.id},io.to(t.id).emit("usersInGroup",groups[t.group]),t.to(t.group).emit("newUser",{id:t.spotifyId,prof_pic:groups[t.group].users[t.spotifyId].prof_pic,name:groups[t.group].users[t.spotifyId].name}),db.insertGroupLog(t.spotifyId,t.group,"ENTER"),db.updateUserGroupId(t.spotifyId,t.group),console.log(groups)}),t.on("weAreHere",function(o){io.to(o.socketId).emit("weAreHere",{context:o.context,uri:o.uri,position:o.position,paused:o.paused,queue:groups[t.group].queue})}),t.on("whereAreWe",function(){io.to(groups[t.group].hostSocket).emit("whereAreWe",t.id)}),t.on("disconnect",function(){void 0!==t.spotifyId&&(db.insertGroupLog(t.spotifyId,t.group,"EXIT"),io.to(t.group).emit("userLeft",t.spotifyId),delete groups[t.group].users[t.spotifyId],0==Object.keys(groups[t.group].users).length?delete groups[t.group]:groups[t.group].host==t.spotifyId&&(groups[t.group].host=Object.keys(groups[t.group].users)[0],groups[t.group].hostSocket=groups[t.group].users[groups[t.group].host].socket),db.updateUserGroupId(t.spotifyId,null),console.log(groups))}),t.on("message",function(o){for(var e,r=!1,s=0;s<banned_words.length;s++)if(o.includes(banned_words[s])){r=!0,e=banned_words[s];break}r?(io.to(t.id).emit("messageBanned",e),db.logBannedWord(e,t.spotifyId,t.group,o)):(db.logMessage(o,t.spotifyId,t.group),io.to(t.group).emit("newMessage",{id:t.spotifyId,message:o}))}),t.on("typing",function(){t.to(t.group).emit("typing",t.spotifyId)}),t.on("pause",function(){z,t.to(t.group).emit("pause",t.spotifyId)}),t.on("resume",function(){t.to(t.group).emit("resume",t.spotifyId)}),t.on("changeSong",function(o){groups[t.group].host==t.spotifyId&&(t.to(t.group).emit("changeSong",{uri:o.uri,context:o.context,paused:o.paused,name:o.name,id:t.spotifyId}),groups[t.group].queue.includes(o.uri)&&groups[t.group].queue.splice(groups[t.group].queue.indexOf(o.uri),1),console.log(groups[t.group].queue))}),t.on("addToQueue",function(o){t.to(t.group).emit("addToQueue",{uri:o.uri,name:o.name,artist:o.artist,image:o.image,id:t.spotifyId}),groups[t.group].queue.push(o.uri),console.log(groups[t.group].queue)}),t.on("makeMeHost",function(){groups[t.group].host=t.spotifyId,groups[t.group].hostSocket=t.id}),t.on("banUser",function(a){console.log("RECEIEVED"),null!=a.accessToken&&(console.log("NON NULL"),db.checkAccessToken(a.accessToken,function(o){if(o)for(var e=0,r=Object.entries(groups);e<r.length;e++){var s=_slicedToArray(r[e],2),t=s[0],u=s[1];console.log("GROUP"),console.log(t),console.log(u);for(var n=0,i=Object.entries(u.users);n<i.length;n++){var p=_slicedToArray(i[n],2),g=p[0],d=p[1];console.log("USER"),console.log(g),console.log(d),g==a.id&&(console.log("MATCH"),io.to(d.socket).emit("userBanned"))}}}))})});