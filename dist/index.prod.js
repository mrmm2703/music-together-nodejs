"use strict";function _slicedToArray(o,e){return _arrayWithHoles(o)||_iterableToArrayLimit(o,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(o,e){if(Symbol.iterator in Object(o)||"[object Arguments]"===Object.prototype.toString.call(o)){var r=[],t=!0,s=!1,i=void 0;try{for(var u,n=o[Symbol.iterator]();!(t=(u=n.next()).done)&&(r.push(u.value),!e||r.length!==e);t=!0);}catch(o){s=!0,i=o}finally{try{t||null==n.return||n.return()}finally{if(s)throw i}}return r}}function _arrayWithHoles(o){if(Array.isArray(o))return o}var fs=require("fs"),https=require("https"),mysql=require("mysql"),DatabasePool=require("./db"),SpotifyConnection=require("./spotify"),BAN_TIME=12,BAN_WORD_LIMIT=2,db=new DatabasePool,banned_words=db.getBannedWords(),server=https.createServer({key:fs.readFileSync("/home/azureuser/private.key"),cert:fs.readFileSync("/home/azureuser/certificate.crt")}),io=require("socket.io")(server,{cors:{origin:"https://morahman.me",methods:["GET","POST"]}});server.listen(3e3);var spotify=new SpotifyConnection,groups={},groups={};function getDate(){var o=new Date;return o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear()}spotify.on("follow_playlist",function(o){console.log(o),groups[o.groupId].collabId=o.playlistId,io.to(o.groupId).emit("followPlaylist",o.playlistId)}),spotify.on("playlist",function(o){io.to(o.groupId).emit("updatePlaylist",o.playlistId)}),io.on("connection",function(s){console.log("New connection."),s.on("auth_code",function(o){spotify.activateAuthCode(o).then(function(o){spotify.setToken(o),spotify.startRefreshSequence()})}),s.on("refreshBannedWords",function(){banned_words=db.getBannedWords(),console.log("Refreshing banned words...")}),s.on("joinedGroup",function(o){s.spotifyId=o.id,s.group=o.group,s.join(o.group),groups.hasOwnProperty(s.group)||(groups[s.group]={users:{},likes:{},queue:[],host:s.spotifyId,hostSocket:s.id,collabId:null}),groups[s.group].users[s.spotifyId]={prof_pic:o.prof_pic,name:o.name,socket:s.id},io.to(s.id).emit("usersInGroup",groups[s.group]),s.to(s.group).emit("newUser",{id:s.spotifyId,prof_pic:groups[s.group].users[s.spotifyId].prof_pic,name:groups[s.group].users[s.spotifyId].name}),null!=groups[s.group].collabId&&(io.to(s.id).emit("followPlaylist",groups[s.group].collabId),io.to(s.id).emit("updatePlaylist",groups[s.group].collabId)),db.insertGroupLog(s.spotifyId,s.group,"ENTER"),db.updateUserGroupId(s.spotifyId,s.group),console.log(groups)}),s.on("weAreHere",function(o){io.to(o.socketId).emit("weAreHere",{context:o.context,uri:o.uri,position:o.position,paused:o.paused,queue:groups[s.group].queue,duration:o.duration})}),s.on("whereAreWe",function(){io.to(groups[s.group].hostSocket).emit("whereAreWe",s.id)}),s.on("disconnect",function(){void 0!==s.spotifyId&&(db.insertGroupLog(s.spotifyId,s.group,"EXIT"),io.to(s.group).emit("userLeft",s.spotifyId),delete groups[s.group].users[s.spotifyId],0==Object.keys(groups[s.group].users).length?delete groups[s.group]:groups[s.group].host==s.spotifyId&&(groups[s.group].host=Object.keys(groups[s.group].users)[0],groups[s.group].hostSocket=groups[s.group].users[groups[s.group].host].socket),db.updateUserGroupId(s.spotifyId,null),console.log(groups))}),s.on("message",function(o){for(var e,r=!1,t=0;t<banned_words.length;t++)if(o.toLowerCase().includes(banned_words[t])){r=!0,e=banned_words[t];break}r?(io.to(s.id).emit("messageBanned",e),db.getRecentBannedWords(s.spotifyId,BAN_TIME).then(function(o){console.log("BANNED COUNT: "+o),BAN_WORD_LIMIT<o+1&&(console.log("LIMIT REACHED"),db.banUser(s.spotifyId),io.to(s.id).emit("userBanned"))}),db.logBannedWord(e,s.spotifyId,s.group,o)):(db.logMessage(o,s.spotifyId,s.group),io.to(s.group).emit("newMessage",{id:s.spotifyId,message:o}))}),s.on("typing",function(){s.to(s.group).emit("typing",s.spotifyId)}),s.on("pause",function(){s.to(s.group).emit("pause",s.spotifyId)}),s.on("resume",function(){s.to(s.group).emit("resume",s.spotifyId)}),s.on("seek",function(o){s.to(s.group).emit("seek",{id:s.spotifyId,pos:o})}),s.on("changeSong",function(o){groups[s.group].host==s.spotifyId&&(s.to(s.group).emit("changeSong",{uri:o.uri,context:o.context,paused:o.paused,name:o.name,id:s.spotifyId}),groups[s.group].queue.includes(o.uri)&&groups[s.group].queue.splice(groups[s.group].queue.indexOf(o.uri),1),console.log(groups[s.group].queue))}),s.on("addToQueue",function(o){s.to(s.group).emit("addToQueue",{uri:o.uri,name:o.name,artist:o.artist,image:o.image,id:s.spotifyId}),groups[s.group].queue.push(o.uri),console.log(groups[s.group].queue)}),s.on("makeMeHost",function(){groups[s.group].host=s.spotifyId,groups[s.group].hostSocket=s.id}),s.on("banUser",function(a){null!=a.accessToken&&db.checkAccessToken(a.accessToken,function(o){if(o)for(var e=0,r=Object.entries(groups);e<r.length;e++)for(var t=_slicedToArray(r[e],2),s=(t[0],t[1]),i=0,u=Object.entries(s.users);i<u.length;i++){var n=_slicedToArray(u[i],2),p=n[0],g=n[1];p==a.id&&io.to(g.socket).emit("userBanned")}})}),s.on("addToPlaylist",function(o){console.log("songUri:"),console.log(o),null==groups[s.group].collabId?spotify.addToQueue("create_playlist",{name:"Collab ("+s.group+")",description:"Music Together session on "+getDate()+". Group ID: "+s.group,songUri:"spotify:track:"+o},s.group):spotify.addToQueue("add_to_playlist",{playlistId:groups[s.group].collabId,songId:"spotify:track:"+o},s.group)}),s.on("newPlaylist",function(o){groups[s.group].collabId=o.collabUri,s.to(s.group).emit("followPlaylist",o.collabUri),io.to(s.id).emit("collabUri",{songId:o.songId,collabUri:groups[s.group].collabId})}),s.on("newPlaylistItem",function(){s.to(s.group).emit("updatePlaylist",groups[s.group].collabId)}),s.on("changeName",function(o){groups[s.group].users[s.spotifyId].name=o,io.to(s.group).emit("updateName",{id:s.spotifyId,name:o})}),s.on("changeProfPic",function(o){groups[s.group].users[s.spotifyId].prof_pic=o,io.to(s.group).emit("updateProfPic",{id:s.spotifyId,profPic:o})}),s.on("likeSong",function(o){null==groups[s.group].likes[o]&&(groups[s.group].likes[o]=[]),groups[s.group].likes[o].push(s.spotifyId),io.to(s.group).emit("updateLikes",{songId:o,users:groups[s.group].likes[o]})}),s.on("unlikeSong",function(o){var e=groups[s.group].likes[o].indexOf(s.spotifyId);-1<e&&groups[s.group].likes[o].splice(e,1),io.to(s.group).emit("updateLikes",{songId:o,users:groups[s.group].likes[o]})})});