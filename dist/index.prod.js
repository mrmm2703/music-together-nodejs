"use strict";var fs=require("fs"),https=require("https"),mysql=require("mysql"),DatabasePool=require("./db"),db=new DatabasePool,banned_words=db.getBannedWords(),server=https.createServer({key:fs.readFileSync("/home/azureuser/private.key"),cert:fs.readFileSync("/home/azureuser/certificate.crt")}),io=require("socket.io")(server,{cors:{origin:"https://morahman.me",methods:["GET","POST"]}});server.listen(3e3);var groups={};io.on("connection",function(u){console.log("New connection."),u.on("refreshBannedWords",function(){banned_words=db.getBannedWords(),console.log("Refreshing banned words...")}),u.on("joinedGroup",function(o){u.spotifyId=o.id,u.group=o.group,u.join(o.group),groups.hasOwnProperty(u.group)||(groups[u.group]={users:{},likes:{},queue:[],host:u.spotifyId,hostSocket:u.id}),groups[u.group].users[u.spotifyId]={prof_pic:o.prof_pic,name:o.name,socket:u.id},io.to(u.id).emit("usersInGroup",groups[u.group]),u.to(u.group).emit("newUser",{id:u.spotifyId,prof_pic:groups[u.group].users[u.spotifyId].prof_pic,name:groups[u.group].users[u.spotifyId].name}),db.insertGroupLog(u.spotifyId,u.group,"ENTER"),db.updateUserGroupId(u.spotifyId,u.group),console.log(groups)}),u.on("weAreHere",function(o){io.to(o.socketId).emit("weAreHere",{context:o.context,uri:o.uri,position:o.position,paused:o.paused,queue:groups[u.group].queue})}),u.on("whereAreWe",function(){io.to(groups[u.group].hostSocket).emit("whereAreWe",u.id)}),u.on("disconnect",function(){void 0!==u.spotifyId&&(db.insertGroupLog(u.spotifyId,u.group,"EXIT"),io.to(u.group).emit("userLeft",u.spotifyId),delete groups[u.group].users[u.spotifyId],0==Object.keys(groups[u.group].users).length?delete groups[u.group]:groups[u.group].host==u.spotifyId&&(groups[u.group].host=Object.keys(groups[u.group].users)[0],groups[u.group].hostSocket=groups[u.group].users[groups[u.group].host].socket),db.updateUserGroupId(u.spotifyId,null),console.log(groups))}),u.on("message",function(o){for(var e,r=!1,s=0;s<banned_words.length;s++)if(o.includes(banned_words[s])){r=!0,e=banned_words[s];break}r?(io.to(u.id).emit("messageBanned",e),db.logBannedWord(e,u.spotifyId,u.group,o)):(db.logMessage(o,u.spotifyId,u.group),io.to(u.group).emit("newMessage",{id:u.spotifyId,message:o}))}),u.on("typing",function(){u.to(u.group).emit("typing",u.spotifyId)}),u.on("pause",function(){u.to(u.group).emit("pause",u.spotifyId)}),u.on("resume",function(){u.to(u.group).emit("resume",u.spotifyId)}),u.on("changeSong",function(o){groups[u.group].host==u.spotifyId&&(u.to(u.group).emit("changeSong",{uri:o.uri,context:o.context,paused:o.paused,name:o.name,id:u.spotifyId}),groups[u.group].queue.includes(o.uri)&&groups[u.group].queue.splice(groups[u.group].queue.indexOf(o.uri),1),console.log(groups[u.group].queue))}),u.on("addToQueue",function(o){u.to(u.group).emit("addToQueue",{uri:o.uri,name:o.name,artist:o.artist,image:o.image,id:u.spotifyId}),groups[u.group].queue.push(o.uri),console.log(groups[u.group].queue)}),u.on("makeMeHost",function(){groups[u.group].host=u.spotifyId,groups[u.group].hostSocket=u.id})});