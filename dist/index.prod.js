"use strict";var fs=require("fs"),https=require("https"),mysql=require("mysql"),DatabasePool=require("./db"),db=new DatabasePool,banned_words=db.getBannedWords(),server=https.createServer({key:fs.readFileSync("/home/azureuser/private.key"),cert:fs.readFileSync("/home/azureuser/certificate.crt")}),io=require("socket.io")(server,{cors:{origin:"https://morahman.me",methods:["GET","POST"]}});server.listen(3e3);var groups={};io.on("connection",function(p){console.log("New connection."),console.log(banned_words),p.on("joinedGroup",function(o){p.spotifyId=o.id,p.group=o.group,p.join(o.group),groups.hasOwnProperty(p.group)||(groups[p.group]={users:{},likes:{}}),groups[p.group].users[p.spotifyId]={prof_pic:o.prof_pic,name:o.name},io.to(p.id).emit("usersInGroup",groups[p.group]),p.to(p.group).emit("newUser",{id:p.spotifyId,prof_pic:groups[p.group].users[p.spotifyId].prof_pic,name:groups[p.group].users[p.spotifyId].name}),db.insertGroupLog(p.spotifyId,p.group,"ENTER"),db.updateUserGroupId(p.spotifyId,p.group),console.log(groups)}),p.on("disconnect",function(){db.insertGroupLog(p.spotifyId,p.group,"EXIT"),io.to(p.group).emit("userLeft",p.spotifyId),delete groups[p.group].users[p.spotifyId],0==Object.keys(groups[p.group].users).length&&delete groups[p.group],db.updateUserGroupId(p.spotifyId,null),console.log(groups)}),p.on("message",function(o){for(var e,r=!1,s=0;s<banned_words.length;s++)if(o.includes(banned_words[s])){r=!0,e=banned_words[s];break}r?(io.to(p.id).emit("messageBanned",e),db.logBannedWord(e,p.spotifyId,p.group,o)):(db.logMessage(o,p.spotifyId,p.group),io.to(p.group).emit("newMessage",{id:p.spotifyId,message:o}))}),p.on("typing",function(){io.to(p.group).emit("typing",p.spotifyId)})});