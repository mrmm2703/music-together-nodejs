"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var https=require("https"),querystring=require("querystring"),queue=require("./queue"),EventEmitter=require("events"),clientId="4a8fd972e1764fb8ac898d19335a9081",clientSecret="bfd33fd015ef48a4a39cd121b87f7091",base64auth=Buffer.from(clientId+":"+clientSecret).toString("base64"),scope="playlist-modify-public playlist-modify-private",userId="u051288nb9jvms048f9zqxn42",apiEndpoint="api.spotify.com",redirectUri="https://morahman.me/musictogether/auth/show_token.php",SpotifyConnection=function(){function t(){var e;return _classCallCheck(this,t),e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),console.log("Get authorisation code from:"),console.log("https://accounts.spotify.com/authorize?client_id="+clientId+"&response_type=code&redirect_uri="+redirectUri+"&scope="+scope),e.accessToken=null,e.refreshToken=null,e.tokenExpires=null,e.operations=new queue,e.running=!1,e}return _inherits(t,EventEmitter),_createClass(t,[{key:"activateAuthCode",value:function(i){return new Promise(function(t,o){var e=querystring.stringify({grant_type:"authorization_code",code:i,redirect_uri:redirectUri,client_id:clientId,client_secret:clientSecret}),n={hostname:"accounts.spotify.com",path:"/api/token",port:443,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(e)}},r=https.request(n,function(e){e.on("data",function(e){t(JSON.parse(e.toString()))})});r.on("error",function(e){o(e)}),r.end(e)})}},{key:"setToken",value:function(e){console.log(e),console.log(""),this.accessToken=e.access_token,this.refreshToken=void 0===e.refresh_token?this.refreshToken:e.refresh_token,this.tokenExpires=e.expires_in}},{key:"startRefreshSequence",value:function(){var t=this;setTimeout(function(){console.log("Refreshing token..."),t.refreshAccessToken().then(function(e){t.setToken(e),console.log("New token: "+t.accessToken),console.log("New refresh token: "+t.refreshToken),console.log("Expires in: "+t.tokenExpires),t.startRefreshSequence()})},1e3*(this.tokenExpires-15))}},{key:"refreshAccessToken",value:function(){var i=this;return new Promise(function(t,o){var e=querystring.stringify({grant_type:"refresh_token",refresh_token:i.refreshToken}),n={hostname:"accounts.spotify.com",path:"/api/token",port:443,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(e),Authorization:"Basic "+base64auth}},r=https.request(n,function(e){e.on("data",function(e){t(JSON.parse(e.toString()))})});r.on("error",function(e){o(e)}),r.end(e)})}},{key:"addToQueue",value:function(e,t,o){console.log("ADDING TO QUEUE"),this.operations.enqueue({type:e,data:t,groupId:o}),console.log("IN QUEUE:"),console.log(this.operations.peek()),0==this.running&&(console.log("NOT RUNNING. RUNNING RUNCALLER"),this.runCaller())}},{key:"runCaller",value:function(){this.operations.isEmpty()?(console.log("OPERATIONS IS EMPTY"),this.running=!1):(console.log("OPERATIONS IS NOT EMPTY. RUNNING RUNOPERATION"),this.running=!0,this.runOperation())}},{key:"runOperation",value:function(){var t=this,e=this.operations.peek();console.log("NEW OPERATION:"),console.log(e),console.log(""),"create_playlist"==e.type?(console.log("RUNOPERATION FOUND A CREATE PLAYLIST COMMAND"),this.createPlaylist(e.data.name,e.data.description,e.groupId,e.data.songUri).then(function(e){return t.createPlaylistCallback(e)},function(e){return t.callerWait(e)})):"add_to_playlist"==e.type&&(console.log("ADD TO PLAYLIST FOUND"),this.addToPlaylist(e.data.playlistId,e.data.songId,e.groupId).then(function(e){return t.playlistCallback(e)},function(e){return t.callerWait(e)}))}},{key:"createPlaylistCallback",value:function(e){console.log("CREATE PLAYLIST CALLBACK"),console.log(e),this.emit("follow_playlist",{groupId:e.groupId,playlistId:e.playlistId}),this.playlistCallback(e)}},{key:"playlistCallback",value:function(e){var t=this;console.log(""),console.log("PLAYLIST CALLBACK"),console.log(e),void 0!==e.songUri?this.addToPlaylist(e.playlistId,e.songUri,e.groupId).then(function(){t.operations.dequeue(),t.emit("playlist",{groupId:e.groupId,playlistId:e.playlistId}),t.runCaller()}):(this.operations.dequeue(),this.emit("playlist",{groupId:e.groupId,playlistId:e.playlistId}),this.runCaller())}},{key:"callerWait",value:function(e){var t=this;setTimeout(function(){console.log("WAIT DONE! RUNNING RUN CALLER"),t.runCaller()},1e3*e)}},{key:"createPlaylist",value:function(s,l,a,c){var u=this;return new Promise(function(t,o){var n="",e=JSON.stringify({name:s,description:l,public:!1,collaborative:!1}),r={hostname:apiEndpoint,path:"/v1/users/"+userId+"/playlists",port:443,method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+u.accessToken}},i=https.request(r,function(e){429==e.statusCode&&(console.log("CREATE PLAYLIST: GOT 429"),console.log(e.headers),process.stdout.write(e.headers),console.log(" ^ HEADERS"),e.headers["Retry-After"],o(e.headers["Retry-After"])),e.on("data",function(e){n+=e,console.log("GOT DATA!!!"),process.stdout.write(e)}),e.on("end",function(){t({groupId:a,playlistId:JSON.parse(n.toString()).id,songUri:c})})});i.on("error",function(e){console.error("SPOTIFY ERROR"),console.error(e)}),i.end(e)})}},{key:"addToPlaylist",value:function(i,s,l){var a=this;return console.log("MAKING PROMISE"),new Promise(function(t,o){console.log("FR MAKING PROMISE...");var e=JSON.stringify({uris:[s]}),n={hostname:apiEndpoint,path:"/v1/playlists/"+i+"/tracks",port:443,method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+a.accessToken}},r=https.request(n,function(e){429==e.statusCode&&(console.log("ADD TO PLAYLIST: GOT 429"),console.log(e.headers),process.stdout.write(e.headers),console.log(" ^ HEADERS"),e.headers["Retry-After"],o(e.headers["Retry-After"])),e.on("data",function(e){console.log("GOT DATA!!!"),process.stdout.write(e)}),e.on("end",function(){t({groupId:l,playlistId:i})})});r.on("error",function(e){console.error("SPOTIFY ERROR"),console.error(e)}),r.end(e)})}}]),t}();module.exports=SpotifyConnection;